/*set #tar #oper heights*/$(function(){         var otherH = 250;       var box = $('#tar,#oper');      var inners = $('.innerCon');    var innerConMinHeight = 180;    var setH = function(){          var docH = $(window).height();          if(docH-otherH > 150){                  box.height(docH-otherH);                }                               if(docH-otherH-80 > innerConMinHeight){                 inners.height(docH-otherH-80);          }else{                  inners.height(innerConMinHeight);               }                       $('#loading').height($('#operWrap').outerHeight()-83);                  };      $(window).resize(setH); setH();});/*----------------Permission manage functions ---------------*/var updateObj = null;var defaultTrigger = null;/*tab function*/$(function(){   var operTits = $('#oper .tab-tit h3');          /*Change the edit panel*/       var setPanelDisplay = function(str){            operTits.show();                operTits.filter('#'+str+'-edit').hide();                var o = operTits.not('#'+str+'-edit');          if($('#'+str+'-edit').hasClass('current')){                     o.eq(0).click();                }else{                  o.filter('.current').click();           }                                       };      $('.tab-box').each(function(){          var box = $(this);              var start = box.hasClass('tab-start');          var tits = box.find('.tab-tit h3');             var cons = box.find('.tab-con');                        tits.each(function(i){                  var me = $(this);                       var bind = me.attr('bind');                                             me.click(function(){                            tits.filter('.current').removeClass('current');                         me.addClass('current');                         cons.hide();                            cons.eq(i).show();                              if(start){                                      if(bind.indexOf('user') > -1){                                          setPanelDisplay('user');                                                updateObj = 'user';                                     }                                       if(bind.indexOf('group') > -1){                                         setPanelDisplay('group');                                               updateObj = 'group';                                    }                                       if(bind.indexOf('permission') > -1){                                            setPanelDisplay('permission');                                          updateObj = 'permission';                                       }                               }                                                       });                                     });                                     });     $('#user').click();});  $(function(){   var loading = $('#loading');    var user_con = $('#userCon');   var group_con = $('#groupCon'); var permission_con = $('#permissionCon');       var user_edit_con = $('#userEditCon');  var group_edit_con = $('#groupEditCon');        var permission_edit_con = $('#permissionEditCon');                      var user_edit_tit = $('#user-edit');    var group_edit_tit = $('#group-edit');  var permission_edit_tit = $('#permission-edit');        var user_edit_box = $('#oper-user');    var group_edit_box = $('#oper-group');  var permission_edit_box = $('#oper-permission');                var updateBtn = $('#update');                   /*fill user,userEdit datas*/            var userList , groupList , permissionList , userEditList , groupEditList , permissionEditList;  var userStr = groupStr = permissionStr = userEditStr = groupEditStr = permissionEditStr = '<ul class="textlist">';      var isCheckDefault = (defaultType && defaultType != '' && defaultId && parseInt(defaultId) > 0);        var default_trigger_index;              var checkDefaultData = function(id){            return parseInt(id) == defaultId;       };              for(var i=0;i<dataU.length;i++){                var d = dataU[i];               userStr += '<li><a href="javascript:;">'+d.first_name+' '+d.last_name+'</a></li>';              userEditStr += '<li><input type="checkbox" id="u_e_'+d.user_id+'" value="'+d.user_id+'" /><label for="u_e_'+d.user_id+'">'+d.first_name + ' ' + d.last_name+'</label></li>';            if(isCheckDefault && defaultType =='user'){                                             if(checkDefaultData(d.user_id)){                                default_trigger_index = i;                      }               }       }       userStr += '</ul>';     userEditStr += '</ul>'; user_con.prepend(userStr);      user_edit_con.prepend(userEditStr);     userList = user_con.find('li'); userEditList = user_edit_con.find('li');        /*fill group,groupEdit datas*/  for(var i=0;i<dataG.length;i++){                var d = dataG[i];               groupStr += '<li><a href="javascript:;">'+d.name+'</a></li>';           groupEditStr += '<li><input type="checkbox" id="g_e_'+d.group_id+'" value="'+d.group_id+'" /><label for="g_e_'+d.group_id+'">'+d.name+'</label></li>';          if(isCheckDefault && defaultType =='group'){                    if(checkDefaultData(d.group_id)){                               default_trigger_index = i;                      }               }       }       groupStr += '</ul>';    groupEditStr += '</ul>';        group_con.prepend(groupStr);    group_edit_con.prepend(groupEditStr);   groupList = group_con.find('li');       groupEditList = group_edit_con.find('li');              /*fill permission,permissionEdit datas*/        for(var i=0;i<dataP.length;i++){                var d = dataP[i];               permissionStr += '<li><a href="javascript:;">'+d.name+'</a></li>';              permissionEditStr += '<li><input type="checkbox" id="p_e_'+d.permission_id+'" value="'+d.permission_id+'" /><label for="p_e_'+d.permission_id+'">'+d.name+'</label></li>';              if(isCheckDefault && defaultType =='permission'){                                               if(checkDefaultData(d.permission_id)){                          default_trigger_index = i;                      }               }       }       permissionStr += '</ul>';       permissionEditStr += '</ul>';   permission_con.prepend(permissionStr);  permission_edit_con.prepend(permissionEditStr); permissionList = permission_con.find('li');     permissionEditList = permission_edit_con.find('li');                    var showLoading = function(){loading.show();};  var hideLoading = function(){loading.hide();};          /*filter function*/     var filterData = function(t,txt){               var arr,obj;            if(t == 'user'){                        arr = dataU;                    obj = userList;         }               if(t == 'group'){                                               arr = dataG;                    obj = groupList;                }               if(t == 'permission'){                  arr = dataP;                    obj = permissionList;           }               if(t == 'userEdit'){                    arr = dataU;                    obj = userEditList;             }               if(t == 'groupEdit'){                                           arr = dataG;                    obj = groupEditList;            }               if(t == 'permissionEdit'){                      arr = dataP;                    obj = permissionEditList;               }                               if(txt == ''){                  obj.show('fast');                       return;         }                               for(var i=0;i<arr.length;i++){                  var pass = false;                       var o = arr[i];                                         for(var k in o){                                                                if(typeof o[k] == 'string'){                                            if((new RegExp(txt,'gi')).test(o[k])){                                          pass = true;                                                                                            }                               }                                                       }                                                               if(!pass){                              obj.eq(i).hide('fast');                 }else{                          obj.eq(i).show('fast');                 }               }       };                              /*filter set*/  var typeArr = ['user','userEdit','group','groupEdit','permission','permissionEdit'];    for(var i=0;i<typeArr.length;i++){              (function(){                    var s = typeArr[i];                     var txt = $('#filter-'+ s +'-text');                    var btn = $('#filter-'+ s +'-go');                      btn.bind('click',function(){                            var v = $.trim(txt.val());                                              if(v == ''){                                                            filterData(s,'');                               }else{                                  filterData(s,v);                                }                                                       });                     /*                      txt.bind('keypress',function(){                         var v = $.trim(txt.val());                                                      if(v == ''){                                                                    filterData(s,'');                                       }else{                                          filterData(s,v);                                        }                       });                     */              })();                           }                       /*bind Enter key event for search*/     $('.searchBox').each(function(){                var me = $(this);                               me.find(':text').keypress(function(event){                      if(event.keyCode==13){                          $(this).next('.btn2').click();                                                  }               });                     });             /*Default hide right datas*/            var operateContents = $('#operWrap');   var allWrap = $('.func-wrap');  operateContents.hide(); var operHide = true;            /*check checkboxs*/             var updateOperateDate = function(t,data){               if(operHide){                   allWrap.addClass('func-wrap-arrow');                    operateContents.fadeIn(1200);                   operHide=false;         }               var obj1,obj2,arr1,arr2;                                if(t == 'user'){                        if(!data.groups || !data.permissions){return;}                                          obj1 = groupEditList;                   obj2 = permissionEditList;                      arr1 = data.groups;                     arr2 = data.permissions;                                        }               if(t == 'group'){                       if(!data.users || !data.permissions){return;}                                           obj1 = userEditList;                    obj2 = permissionEditList;                      arr1 = data.users;                      arr2 = data.permissions;                }               if(t == 'permission'){                  if(!data.users || !data.groups){return;}                                                obj1 = userEditList;                    obj2 = groupEditList;                   arr1 = data.users;                      arr2 = data.groups;             }                               var chkboxs_1 = obj1.find(':checkbox');         chkboxs_1.removeAttr('checked','checked');              for(var i=0;i<arr1.length;i++){                 var id_str = arr1[i] + '';                                              chkboxs_1.filter('[value='+id_str+']').attr('checked','checked');                                       }               var chkboxs_2 = obj2.find(':checkbox');         chkboxs_2.removeAttr('checked','checked');              for(var i=0;i<arr2.length;i++){                 var id_str = arr2[i] + '';                                              chkboxs_2.filter('[value='+id_str+']').attr('checked','checked');               }                       };                      var curTargetId = null;         /*bind click event for User/Group/Permission list*/             var bindTargetEvent = function(t){              var obj,arr,idName,operate,operArgName;                         if(t == 'user'){                        obj = userList;                 arr = dataU;                    idName ='user_id';                      operate = 'get';                }               if(t == 'group'){                       obj = groupList;                        arr = dataG;                    idName ='group_id';                     operate = 'get';                }               if(t == 'permission'){                  obj = permissionList;                   arr = dataP;                    idName = 'permission_id';                       operate = 'get';                }                               if(operate == 'get'){                   obj.find('a').live('click',function(){                          /*                              if($(this).parent().hasClass('current')){                                       return false;;                          }*/                             showLoading();                          var i = $(this).parent().index();                               userList.filter('.current').removeClass('current');                             groupList.filter('.current').removeClass('current');                            permissionList.filter('.current').removeClass('current');                               obj.eq(i).addClass('current');                          curTargetId = arr[i][idName];                           $.ajax({                                        type:"GET",                                     url:ajaxUrlGet,                                 dataType:'json',                                        data:{                                          'type':t,                                                                               'target_id':curTargetId                                 },                                      success:function(data){                                         hideLoading();                                          if(data.error && data.error != ''){                                                                                                             $.popwin.error(data.error);                                                     return;                                         }else if(data.summary && data.summary != ''){                                                   $.popwin.success(data.summary);                                         }                                               updateOperateDate(t,data);                                      },                                      error:function(error){                                          hideLoading();                                          $.popwin.error(error);                                  }                               });                     });             }                       };              /*bind update function*/        updateBtn.click(function(){             var update1,update2,operName1,operName2;                if(updateObj == 'user'){                        update1 = group_edit_con;                       update2 = permission_edit_con;                  operName1 = 'groups';                   operName2 = 'permissions';                                      }               if(updateObj == 'group'){                       update1 = user_edit_con;                        update2 = permission_edit_con;                  operName1 = 'users';                    operName2 = 'permissions';                                              }               if(updateObj == 'permission'){                  update1 = user_edit_con;                        update2 = group_edit_con;                       operName1 = 'users';                    operName2 = 'groups';                                           }               showLoading();          var checkeds_1 = update1.find(':checkbox:checked');             var checkeds_2 = update2.find(':checkbox:checked');             var temp = 'type='+ updateObj +'&target_id='+curTargetId;               for(var z=0;z<checkeds_1.length;z++){                   temp += '&' + operName1 + '[]=' + checkeds_1.eq(z).val();               }               for(var z=0;z<checkeds_2.length;z++){                   temp += '&' + operName2+ '[]=' + checkeds_2.eq(z).val();                }                               $.ajax({                        type:'POST',                    url:ajaxUrlSet,                 dataType:'json',                        data:temp,                      success:function(data){                         hideLoading();                          if(data.error && data.error != ''){                                                                                             $.popwin.error(data.error);                                     return;                         }else if(data.summary && data.summary != ''){                                   $.popwin.success(data.summary);                         }                                                       },                      error:function(error){                          hideLoading();                          $.popwin.error(error);                  }               });     });             /*bind targetEvent loop*/       for(var i=0;i<typeArr.length;i++){                              bindTargetEvent(typeArr[i]);    }               /*bind Select/Unselect all event*/              var u_toggle = $('#user-select-toggle');                var g_toggle = $('#group-select-toggle');               var p_toggle = $('#permission-select-toggle');          u_toggle.toggle(function(){                             userEditList.filter(':visible').find(':checkbox').attr('checked','checked');                    },function(){           userEditList.filter(':visible').find(':checkbox').removeAttr('checked');                        });             g_toggle.toggle(function(){                             groupEditList.filter(':visible').find(':checkbox').attr('checked','checked');                           },function(){           groupEditList.filter(':visible').find(':checkbox').removeAttr('checked');                       });             p_toggle.toggle(function(){                             permissionEditList.filter(':visible').find(':checkbox').attr('checked','checked');                      },function(){           permissionEditList.filter(':visible').find(':checkbox').removeAttr('checked');                  });                     /*trigger the default*/ if(isCheckDefault){             if(defaultType == 'user'){                      defaultTrigger = userList.eq(default_trigger_index).find('a');                  userList.eq(default_trigger_index).find('a').trigger('click');                                  }               if(defaultType == 'group'){                     defaultTrigger = groupList.eq(default_trigger_index).find('a');                         }               if(defaultType == 'permission'){                        defaultTrigger = permissionList.eq(default_trigger_index).find('a');                    }               defaultTrigger.trigger('click');                $('#'+defaultType).trigger('click');            var def_parent = defaultTrigger.parent();               var def_top = def_parent.position().top;                                var def_wrap = defaultTrigger.parents('.innerCon');                     console.log(def_top+26);                if(def_top > def_wrap.height()){                        def_wrap.scrollTop(def_top+26);         }       }});
